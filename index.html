<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Site Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* Shimmer Loading Placeholder Styles */
        .shimmer {
            animation: shimmer-animation 1.5s infinite linear;
            background: linear-gradient(90deg, #e0e0e0 25%, #f5f5f5 50%, #e0e0e0 75%);
            background-size: 200% 100%;
        }

        .shimmer-text {
            border-radius: 4px;
            height: 1em;
            width: 70%;
        }

        .shimmer-button {
            border-radius: 9999px; /* rounded-full */
            height: 40px;
            width: 150px;
        }
        
        @keyframes shimmer-animation {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Alert Box Styles */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            max-width: 400px;
        }
        .alert-box {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(0);
            opacity: 1;
        }
        .alert-box.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .alert-box.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .alert-box.info {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .alert-box.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="alert-container" class="alert-container"></div>

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Simple Site Builder</h1>
            <div id="auth-controls" class="flex flex-col sm:flex-row items-center gap-4">
                <p id="user-display" class="text-sm text-gray-600 hidden"></p>
                <button id="auth-button" class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium shadow-md hover:bg-blue-700 transition duration-300">Sign In with Google</button>
            </div>
        </div>

        <div id="app-container" class="hidden">
            <div class="mb-6">
                <button id="create-project-btn" class="bg-green-600 text-white px-6 py-2 rounded-full font-medium shadow-md hover:bg-green-700 transition duration-300">Create New Project</button>
            </div>

            <div id="projects-container">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Your Projects</h2>
                <div id="project-list" class="space-y-4">
                    <div class="shimmer-placeholder flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm">
                        <div class="flex-1 space-y-2">
                            <div class="shimmer w-3/4 h-6 rounded-md"></div>
                            <div class="shimmer w-1/2 h-4 rounded-md"></div>
                        </div>
                        <div class="flex gap-2 mt-2 sm:mt-0">
                            <div class="shimmer w-20 h-8 rounded-full"></div>
                            <div class="shimmer w-20 h-8 rounded-full"></div>
                        </div>
                    </div>
                    <div class="shimmer-placeholder flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm">
                        <div class="flex-1 space-y-2">
                            <div class="shimmer w-3/4 h-6 rounded-md"></div>
                            <div class="shimmer w-1/2 h-4 rounded-md"></div>
                        </div>
                        <div class="flex gap-2 mt-2 sm:mt-0">
                            <div class="shimmer w-20 h-8 rounded-full"></div>
                            <div class="shimmer w-20 h-8 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="create-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4">Create New Project</h3>
            <p class="text-gray-600 mb-4">Enter a name for your new site. This will be part of its URL.</p>
            <form id="create-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-gray-700 font-medium mb-1">Project Name</label>
                    <input type="text" id="project-name" name="projectName" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-create" class="px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-300">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 transition duration-300">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-3xl h-5/6 flex flex-col">
            <h3 class="text-2xl font-bold mb-4" id="edit-modal-title">Edit Project</h3>
            <div class="flex-grow flex flex-col space-y-4">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="file-name" placeholder="filename.html" class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="add-file-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-medium hover:bg-indigo-700 transition duration-300 whitespace-nowrap">Add File</button>
                </div>
                <div id="file-tabs" class="flex-shrink-0 flex space-x-2 overflow-x-auto pb-2"></div>
                <textarea id="file-content" class="flex-grow w-full border rounded-lg p-4 font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <div class="flex justify-between items-center mt-4">
                <a id="view-site-btn" target="_blank" class="bg-purple-600 text-white px-4 py-2 rounded-full font-medium hover:bg-purple-700 transition duration-300 whitespace-nowrap">View Site</a>
                <div class="flex gap-2">
                    <button id="delete-file-btn" class="px-4 py-2 rounded-full bg-red-600 text-white font-medium hover:bg-red-700 transition duration-300">Delete File</button>
                    <button id="save-file-btn" class="px-6 py-2 rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 transition duration-300">Save</button>
                    <button id="cancel-edit" class="px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-300">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD_wua7IXkOgDQ08rJ-UmLBVyEoDkd5z40",
            authDomain: "sitemaker-8dc01.firebaseapp.com",
            projectId: "sitemaker-8dc01",
            storageBucket: "sitemaker-8dc01.firebasestorage.app",
            messagingSenderId: "816747054758",
            appId: "1:816747054758:web:d369bc875fa4dda1eb5667",
            measurementId: "G-7SFR36ZJYF"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const authButton = document.getElementById('auth-button');
        const userDisplay = document.getElementById('user-display');
        const appContainer = document.getElementById('app-container');
        const createProjectBtn = document.getElementById('create-project-btn');
        const createModal = document.getElementById('create-modal');
        const createForm = document.getElementById('create-form');
        const cancelCreateBtn = document.getElementById('cancel-create');
        const projectList = document.getElementById('project-list');
        const editModal = document.getElementById('edit-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const fileNameInput = document.getElementById('file-name');
        const addFileBtn = document.getElementById('add-file-btn');
        const fileTabsContainer = document.getElementById('file-tabs');
        const fileContentTextarea = document.getElementById('file-content');
        const saveFileBtn = document.getElementById('save-file-btn');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const viewSiteBtn = document.getElementById('view-site-btn');
        const deleteFileBtn = document.getElementById('delete-file-btn');

        let currentProjectId = null;
        let currentFiles = {};
        let currentUserId = null;

        /**
         * Custom alert function to display messages on the UI.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertBox = document.createElement('div');
            alertBox.className = `alert-box ${type}`;
            alertBox.textContent = message;
            
            alertContainer.appendChild(alertBox);

            setTimeout(() => {
                alertBox.classList.add('fade-out');
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000);
        }

        /**
         * Displays shimmer loading placeholders.
         */
        function showShimmer() {
            projectList.innerHTML = `
                <div class="shimmer-placeholder flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm">
                    <div class="flex-1 space-y-2">
                        <div class="shimmer w-3/4 h-6 rounded-md"></div>
                        <div class="shimmer w-1/2 h-4 rounded-md"></div>
                    </div>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <div class="shimmer w-20 h-8 rounded-full"></div>
                        <div class="shimmer w-20 h-8 rounded-full"></div>
                    </div>
                </div>
                <div class="shimmer-placeholder flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm">
                    <div class="flex-1 space-y-2">
                        <div class="shimmer w-3/4 h-6 rounded-md"></div>
                        <div class="shimmer w-1/2 h-4 rounded-md"></div>
                    </div>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <div class="shimmer w-20 h-8 rounded-full"></div>
                        <div class="shimmer w-20 h-8 rounded-full"></div>
                    </div>
                </div>
            `;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authButton.textContent = 'Sign Out';
                authButton.onclick = () => {
                    signOut(auth);
                    showAlert("Signed out successfully!", "success");
                };
                userDisplay.textContent = `User ID: ${user.uid}`;
                userDisplay.classList.remove('hidden');
                appContainer.classList.remove('hidden');
                showShimmer();
                setupProjectListener();
            } else {
                currentUserId = null;
                authButton.textContent = 'Sign In with Google';
                authButton.onclick = () => signInWithPopup(auth, provider).catch(e => showAlert(`Sign-in failed: ${e.message}`, "error"));
                userDisplay.classList.add('hidden');
                appContainer.classList.add('hidden');
                projectList.innerHTML = '<p class="text-gray-500">Please sign in to view your projects.</p>';
            }
        });

        function getProjectsPath() {
            return `sites`;
        }

        function setupProjectListener() {
            if (!currentUserId) return;
            const projectsRef = collection(db, getProjectsPath());
            const q = query(projectsRef, where("userId", "==", currentUserId));

            onSnapshot(q, (snapshot) => {
                projectList.innerHTML = ''; // Clear placeholders
                if (snapshot.empty) {
                    projectList.innerHTML = '<p class="text-gray-500">No projects found. Create one!</p>';
                }
                snapshot.forEach(doc => {
                    const project = doc.data();
                    const projectId = doc.id;
                    const projectDiv = document.createElement('div');
                    projectDiv.className = 'flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm';
                    projectDiv.innerHTML = `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${project.name}</h3>
                            <p class="text-sm text-gray-500">Created by: ${project.userId}</p>
                            <a href="./viewer.html?site=${projectId}" target="_blank" class="text-blue-600 hover:underline text-sm mt-1 inline-block">View Site</a>
                        </div>
                        <div class="flex gap-2 mt-2 sm:mt-0">
                            <button class="edit-btn bg-yellow-500 text-white px-4 py-2 rounded-full text-sm hover:bg-yellow-600 transition duration-300">Edit</button>
                            <button class="delete-btn bg-red-500 text-white px-4 py-2 rounded-full text-sm hover:bg-red-600 transition duration-300">Delete</button>
                        </div>
                    `;
                    projectDiv.querySelector('.edit-btn').addEventListener('click', () => openEditModal(projectId, project));
                    projectDiv.querySelector('.delete-btn').addEventListener('click', () => deleteProject(projectId));
                    projectList.appendChild(projectDiv);
                });
            }, (error) => {
                console.error("Error fetching projects:", error);
                showAlert("Failed to load projects. Please try again.", "error");
            });
        }

        createProjectBtn.addEventListener('click', () => {
            createModal.classList.remove('hidden');
        });
        cancelCreateBtn.addEventListener('click', () => createModal.classList.add('hidden'));
        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
            currentProjectId = null;
            currentFiles = {};
            fileContentTextarea.value = '';
            fileNameInput.value = '';
        });

        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectName = document.getElementById('project-name').value.trim();
            if (!projectName) {
                showAlert("Project name cannot be empty.", "error");
                return;
            }

            try {
                const projectRef = doc(collection(db, getProjectsPath()));
                const projectId = projectRef.id;

                const initialFiles = {
                    'index.html': `<!DOCTYPE html>
<html>
<head>
    <title>${projectName} - Homepage</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; text-align: center; }
        h1 { color: #333; }
        p { color: #666; }
    </style>
</head>
<body>
    <h1>Welcome to My First Site!</h1>
    <p>This is the default index.html page for your project.</p>
</body>
</html>`
                };

                const newProject = {
                    name: projectName,
                    userId: currentUserId,
                    files: initialFiles
                };

                await setDoc(projectRef, newProject);
                createModal.classList.add('hidden');
                createForm.reset();
                showAlert("Project created successfully!", "success");
                openEditModal(projectId, newProject);

            } catch (e) {
                console.error("Error creating project:", e);
                showAlert("Failed to create project. Please try again.", "error");
            }
        });

        async function openEditModal(projectId, projectData) {
            currentProjectId = projectId;
            editModalTitle.textContent = `Editing: ${projectData.name}`;
            currentFiles = projectData.files;
            
            // Set up link for viewer, defaulting to index.html
            viewSiteBtn.href = `./viewer.html?site=${projectId}&page=index.html`;
            
            renderFileTabs();
            editModal.classList.remove('hidden');
            
            if (currentFiles['index.html']) {
                fileNameInput.value = 'index.html';
                fileContentTextarea.value = currentFiles['index.html'];
            } else {
                fileNameInput.value = '';
                fileContentTextarea.value = '';
            }
        }

        function renderFileTabs() {
            fileTabsContainer.innerHTML = '';
            Object.keys(currentFiles).forEach(filename => {
                const tab = document.createElement('button');
                tab.textContent = filename;
                tab.className = 'px-4 py-2 rounded-full text-sm font-medium transition duration-300';
                tab.className += filename === fileNameInput.value ? ' bg-blue-500 text-white' : ' bg-gray-200 text-gray-700 hover:bg-gray-300';
                tab.addEventListener('click', () => {
                    fileNameInput.value = filename;
                    fileContentTextarea.value = currentFiles[filename];
                    renderFileTabs();
                });
                fileTabsContainer.appendChild(tab);
            });
        }

        addFileBtn.addEventListener('click', () => {
            const fileName = fileNameInput.value.trim();
            if (!fileName) {
                showAlert("File name cannot be empty.", "error");
                return;
            }
            if (currentFiles[fileName]) {
                showAlert("A file with this name already exists.", "error");
                return;
            }
            currentFiles[fileName] = '';
            fileContentTextarea.value = '';
            renderFileTabs();
            fileNameInput.value = fileName;
            fileContentTextarea.focus();
            showAlert(`File '${fileName}' added.`, "success");
        });

        saveFileBtn.addEventListener('click', async () => {
            if (!currentProjectId) {
                showAlert("No project selected to save to.", "error");
                return;
            }
            const fileName = fileNameInput.value.trim();
            const fileContent = fileContentTextarea.value;
            if (!fileName) {
                showAlert("Filename cannot be empty.", "error");
                return;
            }
            
            currentFiles[fileName] = fileContent;

            try {
                const projectRef = doc(db, getProjectsPath(), currentProjectId);
                await setDoc(projectRef, { files: currentFiles }, { merge: true });
                showAlert("File saved successfully!", "success");
                renderFileTabs();
            } catch (e) {
                console.error("Error saving file:", e);
                showAlert("Failed to save file. Please try again.", "error");
            }
        });

        deleteFileBtn.addEventListener('click', async () => {
            const fileName = fileNameInput.value.trim();
            if (!fileName) {
                showAlert("No file selected to delete.", "error");
                return;
            }
            if (fileName === 'index.html') {
                showAlert("You cannot delete the main 'index.html' file.", "error");
                return;
            }
            if (window.confirm(`Are you sure you want to delete the file '${fileName}'?`)) {
                try {
                    delete currentFiles[fileName];
                    const projectRef = doc(db, getProjectsPath(), currentProjectId);
                    await updateDoc(projectRef, { files: currentFiles });
                    
                    showAlert(`File '${fileName}' deleted successfully!`, "success");
                    fileNameInput.value = 'index.html';
                    fileContentTextarea.value = currentFiles['index.html'];
                    renderFileTabs();
                } catch (e) {
                    console.error("Error deleting file:", e);
                    showAlert("Failed to delete file. Please try again.", "error");
                }
            }
        });

        async function deleteProject(projectId) {
            if (!window.confirm("Are you sure you want to delete this project?")) {
                return;
            }
            try {
                const projectRef = doc(db, getProjectsPath(), projectId);
                await deleteDoc(projectRef);
                showAlert("Project deleted successfully!", "success");
            } catch (e) {
                console.error("Error deleting project:", e);
                showAlert("Failed to delete project. Please try again.", "error");
            }
        }

        // Event listener to update "View Site" button
        // This is a new function to ensure the link is always current
        const updateViewSiteLink = () => {
            if (currentProjectId) {
                const fileName = fileNameInput.value.trim();
                if (fileName) {
                    viewSiteBtn.href = `./viewer.html?site=${currentProjectId}&page=${encodeURIComponent(fileName)}`;
                }
            }
        };

        // Attach the new function to relevant events
        fileNameInput.addEventListener('input', updateViewSiteLink);
        fileNameInput.addEventListener('input', renderFileTabs); // Keep the original listener too

        fileTabsContainer.addEventListener('click', updateViewSiteLink);
        saveFileBtn.addEventListener('click', updateViewSiteLink);
    </script>
</body>
</html>
